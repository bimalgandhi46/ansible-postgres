---
- name: Bootstrap servers for Ansible access
  hosts: all
  become: true
  vars:
    ansible_user: ubuntu   # change to debian, centos, or ec2-user if needed
    ssh_public_key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

  tasks:
    - name: Ensure Ansible user exists
      user:
        name: "{{ ansible_user }}"
        shell: /bin/bash
        groups: sudo
        append: yes

    - name: Add SSH public key for Ansible user
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ ssh_public_key }}"

    - name: Allow passwordless sudo for Ansible user
      copy:
        dest: "/etc/sudoers.d/{{ ansible_user }}"
        content: "{{ ansible_user }} ALL=(ALL) NOPASSWD:ALL"
        owner: root
        group: root
        mode: '0440'
